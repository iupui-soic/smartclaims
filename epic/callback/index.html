<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Patient Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 24px;
        }
        .epic-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 18px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .patient-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .patient-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        .patient-info h3 {
            margin: 0 0 5px 0;
            font-size: 24px;
        }
        .patient-info p {
            margin: 0;
            color: #666;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-item {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 8px;
        }
        .info-item label {
            display: block;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .info-item span {
            font-size: 16px;
            font-weight: 500;
        }
        .list-item {
            padding: 12px 15px;
            border-left: 3px solid #667eea;
            background: #f8f9fc;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        .list-item.warning {
            border-left-color: #f5a623;
        }
        .list-item.danger {
            border-left-color: #e74c3c;
        }
        .list-item strong {
            display: block;
            margin-bottom: 3px;
        }
        .list-item small {
            color: #888;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .spinner {
            border: 3px solid #f0f0f0;
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
        }
        .empty {
            text-align: center;
            padding: 30px;
            color: #888;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #f0f0f0;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #user-info {
            font-size: 12px;
            opacity: 0.9;
        }
        .debug-section {
            background: #1a1a2e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üè• Epic Patient Viewer</h1>
                <div id="user-info"></div>
            </div>
            <div class="epic-badge">Connected to Epic</div>
        </header>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading patient data from Epic...</p>
            </div>
        </div>
    </div>

    <script>
        /**
         * Epic SMART on FHIR App - Main Application
         * 
         * This page handles the callback from Epic's authorization server
         * and displays patient data from the FHIR API.
         */

        // Global FHIR client
        let client = null;

        // Initialize the app
        FHIR.oauth2.ready()
            .then(function(smartClient) {
                client = smartClient;
                console.log("SMART client ready:", client);
                
                // Display user info if available
                displayUserInfo();
                
                // Load all patient data
                return loadPatientData();
            })
            .catch(function(error) {
                console.error("SMART initialization error:", error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <div class="error">
                            <strong>‚ùå Connection Failed</strong>
                            <p>${error.message || 'Failed to connect to Epic'}</p>
                            <p style="font-size: 12px;">Make sure you launched from Epic's LaunchPad at 
                               <a href="https://open.epic.com/Launchpad/OAuth2Sso">open.epic.com/Launchpad</a></p>
                        </div>
                    </div>
                `;
            });

        // Display logged-in user information
        function displayUserInfo() {
            const userInfo = document.getElementById('user-info');
            
            // Get user from token response
            if (client.user && client.user.fhirUser) {
                client.request(client.user.fhirUser)
                    .then(function(user) {
                        const name = user.name ? 
                            (user.name[0].given?.join(' ') + ' ' + user.name[0].family) : 
                            'Unknown User';
                        userInfo.textContent = `Logged in as: ${name}`;
                    })
                    .catch(function() {
                        userInfo.textContent = 'User: ' + (client.user.fhirUser || 'Unknown');
                    });
            }
        }

        // Load all patient data
        async function loadPatientData() {
            try {
                // Get patient in context
                const patient = await client.patient.read();
                console.log("Patient:", patient);

                // Build the UI
                let html = buildPatientCard(patient);
                html += buildTabsUI();
                
                document.getElementById('content').innerHTML = html;
                
                // Set up tab functionality
                setupTabs();
                
                // Load data for each tab
                loadConditions();
                loadMedications();
                loadAllergies();
                loadObservations();
                
            } catch (error) {
                console.error("Error loading patient:", error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <div class="error">
                            <strong>‚ùå Error Loading Patient</strong>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Build patient information card
        function buildPatientCard(patient) {
            const name = patient.name?.[0];
            const fullName = name ? 
                `${name.given?.join(' ') || ''} ${name.family || ''}`.trim() : 
                'Unknown';
            const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2);
            
            const birthDate = patient.birthDate || 'Unknown';
            const gender = patient.gender ? 
                patient.gender.charAt(0).toUpperCase() + patient.gender.slice(1) : 
                'Unknown';
            
            // Calculate age
            let age = 'Unknown';
            if (patient.birthDate) {
                const birth = new Date(patient.birthDate);
                const today = new Date();
                age = Math.floor((today - birth) / (365.25 * 24 * 60 * 60 * 1000));
            }
            
            // Get MRN from identifiers
            let mrn = 'N/A';
            if (patient.identifier) {
                const mrnId = patient.identifier.find(id => 
                    id.type?.text === 'MRN' || 
                    id.type?.coding?.some(c => c.code === 'MR')
                );
                if (mrnId) mrn = mrnId.value;
            }
            
            // Get address
            let address = 'Not available';
            if (patient.address?.[0]) {
                const addr = patient.address[0];
                address = [
                    addr.line?.join(', '),
                    addr.city,
                    addr.state,
                    addr.postalCode
                ].filter(Boolean).join(', ');
            }
            
            // Get phone
            let phone = 'Not available';
            if (patient.telecom) {
                const phoneContact = patient.telecom.find(t => t.system === 'phone');
                if (phoneContact) phone = phoneContact.value;
            }

            return `
                <div class="card">
                    <div class="patient-header">
                        <div class="patient-avatar">${initials}</div>
                        <div class="patient-info">
                            <h3>${fullName}</h3>
                            <p>MRN: ${mrn} | FHIR ID: ${patient.id}</p>
                        </div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Date of Birth</label>
                            <span>${birthDate}</span>
                        </div>
                        <div class="info-item">
                            <label>Age</label>
                            <span>${age} years</span>
                        </div>
                        <div class="info-item">
                            <label>Gender</label>
                            <span>${gender}</span>
                        </div>
                        <div class="info-item">
                            <label>Phone</label>
                            <span>${phone}</span>
                        </div>
                        <div class="info-item" style="grid-column: span 2;">
                            <label>Address</label>
                            <span>${address}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Build tabs UI
        function buildTabsUI() {
            return `
                <div class="tabs">
                    <button class="tab active" data-tab="conditions">Conditions</button>
                    <button class="tab" data-tab="medications">Medications</button>
                    <button class="tab" data-tab="allergies">Allergies</button>
                    <button class="tab" data-tab="vitals">Vitals</button>
                    <button class="tab" data-tab="debug">Debug Info</button>
                </div>
                
                <div id="conditions" class="tab-content active">
                    <div class="card">
                        <h2>ü©∫ Active Conditions</h2>
                        <div id="conditions-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading conditions...</p>
                        </div>
                    </div>
                </div>
                
                <div id="medications" class="tab-content">
                    <div class="card">
                        <h2>üíä Current Medications</h2>
                        <div id="medications-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading medications...</p>
                        </div>
                    </div>
                </div>
                
                <div id="allergies" class="tab-content">
                    <div class="card">
                        <h2>‚ö†Ô∏è Allergies</h2>
                        <div id="allergies-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading allergies...</p>
                        </div>
                    </div>
                </div>
                
                <div id="vitals" class="tab-content">
                    <div class="card">
                        <h2>üìä Recent Vitals</h2>
                        <div id="vitals-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading vitals...</p>
                        </div>
                    </div>
                </div>
                
                <div id="debug" class="tab-content">
                    <div class="card">
                        <h2>üîß Debug Information</h2>
                        <div class="debug-section" id="debug-info">
                            Loading debug info...
                        </div>
                    </div>
                </div>
            `;
        }

        // Set up tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Update active tab button
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
            
            // Load debug info
            loadDebugInfo();
        }

        // Load conditions
        async function loadConditions() {
            const container = document.getElementById('conditions-list');
            const patientId = client.patient.id;
            
            try {
                // Try without clinical-status filter first (Epic may not support it for all patients)
                let bundle;
                try {
                    bundle = await client.request(`Condition?patient=${patientId}`);
                } catch (e) {
                    // If that fails, show specific error
                    throw e;
                }
                
                const conditions = bundle.entry?.map(e => e.resource) || [];
                
                if (conditions.length === 0) {
                    container.innerHTML = '<div class="empty">No conditions found for this patient</div>';
                    return;
                }
                
                container.innerHTML = conditions.map(condition => {
                    const name = condition.code?.text || 
                                condition.code?.coding?.[0]?.display || 
                                'Unknown Condition';
                    const date = condition.recordedDate ? 
                        new Date(condition.recordedDate).toLocaleDateString() : 
                        'Date unknown';
                    const severity = condition.severity?.text || '';
                    const status = condition.clinicalStatus?.coding?.[0]?.code || '';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}</strong>
                            <small>Recorded: ${date} ${status ? '| Status: ' + status : ''} ${severity ? '| Severity: ' + severity : ''}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading conditions:", error);
                const errorMsg = error.message || 'Unknown error';
                const statusCode = error.status || error.statusCode || '';
                
                // Check if it's a scope/permission issue
                let helpText = '';
                if (statusCode === 403 || errorMsg.includes('403')) {
                    helpText = '<br><small>This may be due to: (1) The test patient has no conditions, (2) Your app needs Condition.Read API enabled, or (3) Scope mismatch between requested and granted scopes.</small>';
                }
                
                container.innerHTML = 
                    `<div class="error">Error loading conditions: ${statusCode} ${errorMsg}${helpText}</div>`;
            }
        }

        // Load medications
        async function loadMedications() {
            try {
                const bundle = await client.request(
                    `MedicationRequest?patient=${client.patient.id}&status=active`
                );
                
                const medications = bundle.entry?.map(e => e.resource) || [];
                const container = document.getElementById('medications-list');
                
                if (medications.length === 0) {
                    container.innerHTML = '<div class="empty">No active medications found</div>';
                    return;
                }
                
                container.innerHTML = medications.map(med => {
                    let name = 'Unknown Medication';
                    if (med.medicationCodeableConcept) {
                        name = med.medicationCodeableConcept.text || 
                               med.medicationCodeableConcept.coding?.[0]?.display || name;
                    } else if (med.medicationReference?.display) {
                        name = med.medicationReference.display;
                    }
                    
                    const dosage = med.dosageInstruction?.[0]?.text || 
                                  med.dosageInstruction?.[0]?.patientInstruction || 
                                  'No dosage information';
                    const date = med.authoredOn ? 
                        new Date(med.authoredOn).toLocaleDateString() : '';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}</strong>
                            <small>${dosage} ${date ? '| Prescribed: ' + date : ''}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading medications:", error);
                document.getElementById('medications-list').innerHTML = 
                    `<div class="error">Error loading medications: ${error.message}</div>`;
            }
        }

        // Load allergies
        async function loadAllergies() {
            try {
                const bundle = await client.request(
                    `AllergyIntolerance?patient=${client.patient.id}`
                );
                
                const allergies = bundle.entry?.map(e => e.resource) || [];
                const container = document.getElementById('allergies-list');
                
                if (allergies.length === 0) {
                    container.innerHTML = '<div class="empty">No allergies recorded</div>';
                    return;
                }
                
                container.innerHTML = allergies.map(allergy => {
                    const name = allergy.code?.text || 
                                allergy.code?.coding?.[0]?.display || 
                                'Unknown Allergen';
                    const criticality = allergy.criticality || 'Unknown';
                    const reactions = allergy.reaction?.map(r => 
                        r.manifestation?.map(m => m.text || m.coding?.[0]?.display).join(', ')
                    ).join('; ') || 'Not specified';
                    
                    const cssClass = criticality === 'high' ? 'danger' : 
                                    criticality === 'low' ? '' : 'warning';
                    
                    return `
                        <div class="list-item ${cssClass}">
                            <strong>${name}</strong>
                            <small>Criticality: ${criticality} | Reactions: ${reactions}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading allergies:", error);
                document.getElementById('allergies-list').innerHTML = 
                    `<div class="error">Error loading allergies: ${error.message}</div>`;
            }
        }

        // Load vital signs
        async function loadObservations() {
            const container = document.getElementById('vitals-list');
            const patientId = client.patient.id;
            
            try {
                // Try vital-signs category first, fall back to general observations
                let bundle;
                try {
                    bundle = await client.request(
                        `Observation?patient=${patientId}&category=vital-signs&_count=20`
                    );
                } catch (e) {
                    // If category filter fails, try without it
                    console.log("Trying observations without category filter...");
                    bundle = await client.request(
                        `Observation?patient=${patientId}&_count=20`
                    );
                }
                
                const observations = bundle.entry?.map(e => e.resource) || [];
                
                if (observations.length === 0) {
                    container.innerHTML = '<div class="empty">No observations found for this patient</div>';
                    return;
                }
                
                container.innerHTML = observations.map(obs => {
                    const name = obs.code?.text || 
                                obs.code?.coding?.[0]?.display || 
                                'Unknown Observation';
                    
                    let value = 'No value';
                    if (obs.valueQuantity) {
                        value = `${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}`;
                    } else if (obs.valueCodeableConcept) {
                        value = obs.valueCodeableConcept.text || 
                               obs.valueCodeableConcept.coding?.[0]?.display;
                    } else if (obs.component) {
                        // Handle blood pressure style observations
                        value = obs.component.map(c => {
                            const compName = c.code?.coding?.[0]?.display || c.code?.text || '';
                            const compValue = c.valueQuantity ? 
                                `${c.valueQuantity.value}${c.valueQuantity.unit || ''}` : '';
                            return `${compName}: ${compValue}`;
                        }).join(' / ');
                    }
                    
                    const date = obs.effectiveDateTime ? 
                        new Date(obs.effectiveDateTime).toLocaleString() : 
                        'Date unknown';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}: ${value}</strong>
                            <small>${date}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading observations:", error);
                const statusCode = error.status || error.statusCode || '';
                container.innerHTML = 
                    `<div class="error">Error loading vitals: ${statusCode} ${error.message}</div>`;
            }
        }

        // Load debug information
        function loadDebugInfo() {
            const debugInfo = {
                "FHIR Server URL": client.state.serverUrl,
                "Patient ID": client.patient.id,
                "Token Response": {
                    "token_type": client.state.tokenResponse?.token_type,
                    "scope": client.state.tokenResponse?.scope,
                    "patient": client.state.tokenResponse?.patient,
                    "encounter": client.state.tokenResponse?.encounter,
                    "expires_in": client.state.tokenResponse?.expires_in
                },
                "Client ID": client.state.clientId
            };
            
            document.getElementById('debug-info').textContent = 
                JSON.stringify(debugInfo, null, 2);
        }
    </script>
</body>
</html>
